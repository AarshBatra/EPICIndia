---
title: |
  ![](logo.jpg){width=2.5in}  
  PUCC Survey Report
author: "Project Management Unit"
date:  "`r Sys.Date()`"
output: 
   prettydoc::html_pretty:
    theme: tactile
    highlight: vignette
params:
  data: 
    label: "Input Survey dataset:"
    value: data-raw/PUCC Checking by CDVs in Petrol Pumps.csv
    input: file
    
  date_range_ll:
    label: "Start Date"
    value: !r Sys.Date() - 1
    input: date 
    
  date_range_ul:
    label: "End Date"
    value: !r Sys.Date() - 1
    input: date
    
  plot_type:
    label: "Plot Type"
    value: percentage
    input: select
    choices: [percentage, count]  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# note: using load_all and document() within the rmd file is 
# crucial as loading it outside the context of the rmd file 
# (for example in the console) will not give it access to the 
# functions that are stored in the R sub-directory.

devtools::load_all()
devtools::document()

```

```{r libraries, include=FALSE}
library(tidyverse)
library(roxygen2)
library(envnames)
library(tidyr)
library(magrittr)
library(ggplot2)
library(stringr)
library(skimr)
library(purrr)
library(forcats)
library(foreign)
library(haven)
library(dplyr)
library(broom)
library(glue)
library(VIM)
library(outliers)
library(ggplot2)
library(scales)
library(grid)
library(prettydoc)
library(RColorBrewer)
library(psych)
library(lubridate)
library(janitor)
```



```{r PUCOrderFilterData-read-data, include=FALSE}

#> Read raw data---------------------------------------------------------------

pucc_data_raw <- readr::read_csv(params$data)
```




```{r clean-raw-data, include=FALSE}

#> Clean raw data--------------------------------------------------------------

## cleaning steps (in order as they are performed)
# 1. clean column names
# 2. create a "date_only" column from timestamp column
# 3. create a "time_only" column (24 hr format) from timestamp column
# 4. convert "civil_defence_volunteer_name" column to lowercase
# 5. convert "petrol_pump_location" column to lowercase
# 6. coerce "vehicle_category", "vehicle_pucc_valid"
#    , "civil_defence_volunteer_name" columns to class "factor"

pucc_data_cleaned <- pucc_data_raw %>%
  janitor::clean_names() %>%
  dplyr::mutate(date_only = lubridate::date(timestamp), 
                time_only = readr::parse_time(stringr::str_extract(timestamp, "(.:..:.. ..)| (..:..:.. ..)")), civil_defence_volunteer_name = stringr::str_to_lower(civil_defence_volunteer_name), 
                petrol_pump_location = stringr::str_to_lower(petrol_pump_location), 
                vehicle_category = haven::as_factor(vehicle_category), 
                vehicle_pucc_valid = haven::as_factor(vehicle_pucc_valid), 
                civil_defence_volunteer_name = haven::as_factor(civil_defence_volunteer_name)) %>%
  dplyr::select(timestamp, date_only, time_only, tidyselect::everything())

```


```{r filtered_date_range, include=FALSE}

# enter date range for filtering PUC data
date_range <- lubridate::as_date(lubridate::ymd(params$date_range_ll) : lubridate::ymd(params$date_range_ul))

# filtered_dataset
pucc_data_filtered <- pucc_data_cleaned %>%
  dplyr::filter(date_only %in% date_range) 
```

&nbsp;

&nbsp;


## Reporting Summary Statistics from: `r params$date_range_ll` to `r params$date_range_ul`

<hr>

&nbsp;

## Is PUCC Valid?


```{r is_pucc_valid, echo=FALSE}

## Is pucc valid? question bar graph

plot_bargraph(df = pucc_data_filtered, col_to_plot = "vehicle_pucc_valid", type_of_graph = params$plot_type  , xlab = "Is Pollution Certificate Valid?", ylab = params$plot_type, title = "PUCC certificate validity", facet = FALSE, facet_by = "vehicle_category")


## Is pucc valid? summary table (groups: vehicle_pucc_valid)

summarise_df_by_colname(
  df = pucc_data_filtered, col_to_grp_by = "vehicle_pucc_valid"
)
```


&nbsp;

&nbsp;

<hr>

## PUCC Validity across vehicle groups


```{r is_pucc_valid_facetted, echo=FALSE}

## Is pucc valid? question bar graph faceted by vehicle_category

plot_bargraph(df = pucc_data_filtered, col_to_plot = "vehicle_pucc_valid", type_of_graph = params$plot_type, xlab = "Is Pollution Certificate Valid?", ylab = params$plot_type, title = "PUCC certificate validity", facet = TRUE, facet_by = "vehicle_category")


## Is pucc valid? summary table (groups: vehicle_pucc_valid, vehicle_category)

summarise_df_by_colname(
  df = pucc_data_filtered, col_to_grp_by = c("vehicle_pucc_valid", 
                                             "vehicle_category")
)



```

